<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>PostgreSQL Operator Installation</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8"></meta><meta property="og:site_name" content="Crunchy Postgres Operator"></meta><meta property="og:title" content="PostgreSQL Operator Installation"></meta><meta property="og:type" content="website"></meta><meta property="og:image:type" content="image/png"></meta><meta property="og:image" content="{[backrest-url-base]}/logo.svg"></meta><meta name="description" content="PostgreSQL Operator Installation"></meta><meta property="og:description" content="PostgreSQL Operator Installation"></meta><link rel="stylesheet" href="default.css" type="text/css"></link></head><body><div id="header-wrapper"><div class="page-header" id="page-header"><div class="page-header-logo"><img src="logo.svg"></div><div class="page-header-title">PostgreSQL Operator Installation</div></div><div class="page-menu"><div class="menu-body"><div class="menu"><a class="menu-link" href="configuration.html">Configuration</a></div><div class="menu"><a class="menu-link" href="commands.html">Commands</a></div><div class="menu"><a class="menu-link" href="design.html">Design</a></div><div class="menu"><a class="menu-link" href="install.html">Install</a></div><div class="menu"><a class="menu-link" href="quickstarts.html">Quickstarts</a></div></div></div></div><div id="content-wrapper"><div id="sidebar-wrapper"><div id="sidebar"><div class="page-toc"><div class="page-toc-header"><div class="page-toc-title"></div></div><div class="page-toc-body"><div class="section1-toc"><div class="section1-toc-number">1</div><div class="section1-toc-title"><a href="#_project_structure">Project Structure</a></div></div><div class="section1-toc"><div class="section1-toc-number">2</div><div class="section1-toc-title"><a href="#_get_images_and_binaries">Get Images and Binaries</a></div></div><div class="section1-toc"><div class="section1-toc-number">3</div><div class="section1-toc-title"><a href="#_installation_prerequsites">Installation Prerequsites</a></div></div><div class="section1-toc"><div class="section1-toc-number">4</div><div class="section1-toc-title"><a href="#_basic_installation">Basic Installation</a></div><div class="section2-toc"><div class="section2-toc-number">4.1</div><div class="section2-toc-title"><a href="#_basic_installation/_create_hostpath_directory">Create HostPath Directory</a></div></div><div class="section2-toc"><div class="section2-toc-number">4.2</div><div class="section2-toc-title"><a href="#_basic_installation/_deploy_the_operator">Deploy the Operator</a></div></div><div class="section2-toc"><div class="section2-toc-number">4.3</div><div class="section2-toc-title"><a href="#_basic_installation/_verify_operator_status">Verify Operator Status</a></div></div><div class="section2-toc"><div class="section2-toc-number">4.4</div><div class="section2-toc-title"><a href="#_basic_installation/_configure_b_pgo_b_client">Configure <b>pgo</b> Client</a></div></div><div class="section2-toc"><div class="section2-toc-number">4.5</div><div class="section2-toc-title"><a href="#_basic_installation/_verify_b_pgo_b_client">Verify <b>pgo</b> Client</a></div></div></div><div class="section1-toc"><div class="section1-toc-number">5</div><div class="section1-toc-title"><a href="#_custom_installation">Custom Installation</a></div><div class="section2-toc"><div class="section2-toc-number">5.1</div><div class="section2-toc-title"><a href="#_custom_installation/_specify_storage">Specify Storage</a></div></div><div class="section2-toc"><div class="section2-toc-number">5.2</div><div class="section2-toc-title"><a href="#_custom_installation/_change_the_operator_configuration">Change the Operator Configuration</a></div></div><div class="section2-toc"><div class="section2-toc-number">5.3</div><div class="section2-toc-title"><a href="#_custom_installation/_deploy_and_run">Deploy and Run</a></div></div></div></div></div></div></div><div id="page-wrapper"><div id="page-body"><div class="section1"><a id="_project_structure"></a><div class="section1-header"><div class="section1-number">1</div><div class="section1-title">Project Structure</div></div><div class="section-body"><div class="section-body-text">To perform an installation of the operator, first create the project structure as follows on your host, here we assume a local directory called <b>odev</b>:</div><pre class="code-block">export GOPATH=$HOME/odev
mkdir -p $HOME/odev/src $HOME/odev/bin $HOME/odev/pkg
mkdir -p $GOPATH/src/github.com/crunchydata/</pre><div class="section-body-text">Next, get a tagged release of the source code:</div><pre class="code-block">cd $GOPATH/src/github.com/crunchydata
git clone https://github.com/CrunchyData/postgres-operator.git
cd postgres-operator
git checkout 2.6</pre></div></div><div class="section1"><a id="_get_images_and_binaries"></a><div class="section1-header"><div class="section1-number">2</div><div class="section1-title">Get Images and Binaries</div></div><div class="section-body"><div class="section-body-text">To pull prebuilt versions from Dockerhub of the <b>postgres-operator</b> containers, specify the image versions, and execute the following Makefile target:</div><pre class="code-block">export CO_IMAGE_PREFIX=crunchydata
export CO_IMAGE_TAG=centos7-2.6
make pull</pre><div class="section-body-text">To pull down the prebuilt <b>pgo</b> binaries, download the <b>tar.gz</b> release file from the following link:</div><ul class="list-unordered"><li class="list-unordered"><a href="https://github.com/CrunchyData/postgres-operator/releases">Github Releases</a></li><li class="list-unordered">extract (e.g. tar xvzf postgres-operator.2.6-rc1.tar.gz)</li></ul><pre class="code-block">cd $HOME
tar xvzf ./postgres-operator.2.6-rc1.tar.gz</pre><ul class="list-unordered"><li class="list-unordered">copy <b>pgo</b> client to somewhere in your path (e.g. cp pgo /usr/local/bin)</li></ul></div></div><div class="section1"><a id="_installation_prerequsites"></a><div class="section1-header"><div class="section1-number">3</div><div class="section1-title">Installation Prerequsites</div></div><div class="section-body"><div class="section-body-text">To run the operator and the <b>pgo</b> client, you will need the following:</div><ul class="list-unordered"><li class="list-unordered">a running Kube cluster</li><li class="list-unordered">a kubectl client installed and in your PATH and configured to connect to your Kube cluster (e.g. export KUBECONFIG=/etc/kubernetes/admin.conf)</li><li class="list-unordered">a Kube namespace created and set to where you want the operator installed, for this install we assume a namespace of <b>demo</b> has been created</li></ul><pre class="code-block">kubectl create -f examples/demo-namespace.json
kubectl config set-context $(kubectl config current-context) --namespace=demo
kubectl config view | grep namespace</pre></div></div><div class="section1"><a id="_basic_installation"></a><div class="section1-header"><div class="section1-number">4</div><div class="section1-title">Basic Installation</div></div><div class="section-body"><div class="section-body-text">The basic installation uses the default operator configuration settings, these settings assume you want to use HostPath storage on your Kube cluster for database persistence. Other persistent options are available but require the Advanced Installation below.</div><div class="section2"><a id="_basic_installation/_create_hostpath_directory"></a><div class="section2-header"><div class="section2-number">4.1</div><div class="section2-title">Create HostPath Directory</div></div><div class="section-body"><div class="section-body-text">The default Persistent Volume script assumes a default HostPath directory be created called <b>/data</b>:</div><pre class="code-block">sudo mkdir /data
sudo chown 777 /data</pre><div class="section-body-text">Create some sample Persistent Volumes using the following script:</div><pre class="code-block">export CO_NAMESPACE=demo
export CO_CMD=kubectl
export COROOT=$GOPATH/src/github.com/crunchydata/postgres-operator
go get github.com/blang/expenv
$COROOT/pv/create-pv.sh</pre></div></div><div class="section2"><a id="_basic_installation/_deploy_the_operator"></a><div class="section2-header"><div class="section2-number">4.2</div><div class="section2-title">Deploy the Operator</div></div><div class="section-body"><div class="section-body-text">Next, deploy the operator to your Kube cluster:</div><pre class="code-block">cd $COROOT
make deployoperator</pre><div class="section-body-text">Instead of using the bash script you can also deploy the operator using the provided Helm chart:</div><pre class="code-block">cd $COROOT/chart
helm install ./postgres-operator
helm ls</pre></div></div><div class="section2"><a id="_basic_installation/_verify_operator_status"></a><div class="section2-header"><div class="section2-number">4.3</div><div class="section2-title">Verify Operator Status</div></div><div class="section-body"><div class="section-body-text">To verify that the operator is deployed and running, run the following:</div><pre class="code-block">kubectl get pod --selector=name=postgres-operator</pre><div class="section-body-text">You should see output similar to this:</div><pre class="code-block">NAME                                 READY     STATUS    RESTARTS   AGE
postgres-operator-56598999cd-tbg4w   2/2       Running   0          1m</pre><div class="section-body-text">There are 2 containers in the operator pod, both should be <b>ready</b> as above.</div><div class="section-body-text">The operator creates the following Custom Resource Definitions:</div><pre class="code-block">kubectl get crd
NAME                             AGE
pgbackups.cr.client-go.k8s.io    2d
pgclusters.cr.client-go.k8s.io   2d
pgingests.cr.client-go.k8s.io    2d
pgpolicies.cr.client-go.k8s.io   2d
pgreplicas.cr.client-go.k8s.io   2d
pgtasks.cr.client-go.k8s.io      2d
pgupgrades.cr.client-go.k8s.io   2d</pre><div class="section-body-text">At this point, the server side of the operator is deployed and ready.</div><div class="section-body-text">The complete set of environment variables used in the installation so far are:</div><pre class="code-block">export CO_IMAGE_PREFIX=crunchydata
export CO_IMAGE_TAG=centos7-2.6
export GOPATH=$HOME/odev
export GOBIN=$GOPATH/bin
export PATH=$PATH:$GOBIN
export COROOT=$GOPATH/src/github.com/crunchydata/postgres-operator
export CO_CMD=kubectl</pre><div class="section-body-text">You would normally add these into your <b>.bashrc</b> at this point to be used later on or if you want to redeploy the operator.</div></div></div><div class="section2"><a id="_basic_installation/_configure_b_pgo_b_client"></a><div class="section2-header"><div class="section2-number">4.4</div><div class="section2-title">Configure <b>pgo</b> Client</div></div><div class="section-body"><div class="section-body-text">The <b>pgo</b> command line client requires TLS for securing the connection to the operator's REST API. This configuration is performed as follows:</div><pre class="code-block">export PGO_CA_CERT=$COROOT/conf/apiserver/server.crt
export PGO_CLIENT_CERT=$COROOT/conf/apiserver/server.crt
export PGO_CLIENT_KEY=$COROOT/conf/apiserver/server.key</pre><div class="section-body-text">The <b>pgo</b> client uses Basic Authentication to authenticate to the operator REST API, for authentication, add the following <b>.pgouser</b> file to your $HOME:</div><pre class="code-block">echo "username:password" > $HOME/.pgouser</pre><div class="section-body-text">The <b>pgo</b> client needs the URL to connect to the operator.</div><div class="section-body-text">Depending on your Kube environment this can be done the following ways:</div><div class="section3"><a id="_basic_installation/_configure_b_pgo_b_client/_running_kube_locally"></a><div class="section3-header"><div class="section3-number">4.4.1</div><div class="section3-title">Running Kube Locally</div></div><div class="section-body"><div class="section-body-text">If your local host is not set up to resolve Kube Service DNS names, you can specify the operator IP address as follows:</div><pre class="code-block">kubectl get service postgres-operator
NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
postgres-operator   NodePort   10.109.184.8   <none>        8443:30894/TCP   5m

export CO_APISERVER_URL=https://10.109.184.8:8443
pgo version</pre><div class="section-body-text">You can also define a bash alias like:</div><pre class="code-block">alias setip='export CO_APISERVER_URL=https://`kubectl get service postgres-operator -o=jsonpath="{.spec.clusterIP}"`:8443'</pre><div class="section-body-text">This alias will set the CO_APISERVER_URL IP address for you!</div></div></div><div class="section3"><a id="_basic_installation/_configure_b_pgo_b_client/_running_kube_remotely"></a><div class="section3-header"><div class="section3-number">4.4.2</div><div class="section3-title">Running Kube Remotely</div></div><div class="section-body"><div class="section-body-text">Set up a port-forward tunnel from your host to the Kube remote host, specifying the operator pod:</div><pre class="code-block">kubectl get pod --selector=name=postgres-operator
NAME                                 READY     STATUS    RESTARTS   AGE
postgres-operator-56598999cd-tbg4w   2/2       Running   0          8m

kubectl port-forward postgres-operator-56598999cd-tbg4w 8443:8443</pre><div class="section-body-text">In another terminal:</div><pre class="code-block">export CO_APISERVER_URL=https://127.0.0.1:8443
pgo version</pre></div></div></div></div><div class="section2"><a id="_basic_installation/_verify_b_pgo_b_client"></a><div class="section2-header"><div class="section2-number">4.5</div><div class="section2-title">Verify <b>pgo</b> Client</div></div><div class="section-body"><div class="section-body-text">At this point you should be able to connect to the operator as follows:</div><pre class="code-block">pgo version
pgo client version 2.6
apiserver version 2.6</pre><div class="section-body-text"><b>pgo</b> commands are documented on the <a href="docs/commands.asciidoc">Commands</a> page.</div></div></div></div></div><div class="section1"><a id="_custom_installation"></a><div class="section1-header"><div class="section1-number">5</div><div class="section1-title">Custom Installation</div></div><div class="section-body"><div class="section-body-text">Most users after they try out the operator will want to create a more customized installation and deployment of the operator.</div><div class="section2"><a id="_custom_installation/_specify_storage"></a><div class="section2-header"><div class="section2-number">5.1</div><div class="section2-title">Specify Storage</div></div><div class="section-body"><div class="section-body-text">The operator will work with HostPath, NFS, and Dynamic Storage.</div><div class="section3"><a id="_custom_installation/_specify_storage/_nfs"></a><div class="section3-header"><div class="section3-number">5.1.1</div><div class="section3-title">NFS</div></div><div class="section-body"><div class="section-body-text">To configure the operator to use NFS for storage, a sample <b>pgo.yaml.nfs</b> file is provided. Overlay the default <b>pgo.yaml</b> file with that file:</div><pre class="code-block">cp $COROOT/examples/pgo.yaml.nfs $COROOT/conf/apiserver/pgo.yaml</pre><div class="section-body-text">Edit the <b>pgo.yaml</b> file to specify the NFS GID that is set for the NFS volume mount you will be using, the default value assumed is <b>nfsnobody</b> as the GID (65534). Update the value to meet your NFS security settings.</div><div class="section-body-text">There is currently no script available to create your NFS Persistent Volumes but you can typically modify the $COROOT/pv/create-pv.sh script to work with NFS.</div></div></div><div class="section3"><a id="_custom_installation/_specify_storage/_dynamic_storage"></a><div class="section3-header"><div class="section3-number">5.1.2</div><div class="section3-title">Dynamic Storage</div></div><div class="section-body"><div class="section-body-text">To configure the operator to use Dynamic Storage classes for storage, a sample <b>pgo.yaml.storageclass</b> file is provided. Overlay the default <b>pgo.yaml</b> file with that file:</div><pre class="code-block">cp $COROOT/examples/pgo.yaml.storageclass $COROOT/conf/apiserver/pgo.yaml</pre><div class="section-body-text">Edit the <b>pgo.yaml</b> file to specify the storage class you will be using, the default value assumed is <b>standard</b> which is the name used by default within a GKE Kube cluster deployment. Update the value to match your storage classes.</div><div class="section-body-text">Notice that the <b>FsGroup</b> setting is required for most block storage and is set to the value of <b>26</b> since the PostgreSQL container runs as UID <b>26</b>.</div></div></div></div></div><div class="section2"><a id="_custom_installation/_change_the_operator_configuration"></a><div class="section2-header"><div class="section2-number">5.2</div><div class="section2-title">Change the Operator Configuration</div></div><div class="section-body"><div class="section-body-text">There are many ways to configure the operator, those configurations are documented on the <a href="docs/configuration.asciidoc">Configuration</a> page.</div><div class="section-body-text">Reasonable defaults are specified which allow users to typically run the operator at this point so you might not initially require any customization beyond specifying your storage.</div></div></div><div class="section2"><a id="_custom_installation/_deploy_and_run"></a><div class="section2-header"><div class="section2-number">5.3</div><div class="section2-title">Deploy and Run</div></div><div class="section-body"><div class="section-body-text">At this point, you can use the Basic Installation Deploy steps to deploy the operator and run the <b>pgo</b> client.</div></div></div></div></div><div class="page-footer text-center">Prepared by Crunchy Data Solutions, Inc. &mdash; April 6, 2018</div></div></div></div></body></html>