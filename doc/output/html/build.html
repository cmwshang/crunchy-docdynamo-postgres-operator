<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>PostgreSQL Operator Build Instructions</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8"></meta><meta property="og:site_name" content="Crunchy Postgres Operator"></meta><meta property="og:title" content="PostgreSQL Operator Build Instructions"></meta><meta property="og:type" content="website"></meta><meta property="og:image:type" content="image/png"></meta><meta property="og:image" content="{[backrest-url-base]}/logo.svg"></meta><meta name="description" content="PostgreSQL Operator Build Instructions"></meta><meta property="og:description" content="PostgreSQL Operator Build Instructions"></meta><link rel="stylesheet" href="default.css" type="text/css"></link></head><body><div id="header-wrapper"><div class="page-header" id="page-header"><div class="page-header-logo"><img src="logo.svg"></div><div class="page-header-title">PostgreSQL Operator Build Instructions</div></div><div class="page-menu"><div class="menu-body"><div class="menu"><a class="menu-link" href="install.html">Install</a></div><div class="menu"><a class="menu-link" href="configuration.html">Configuration</a></div><div class="menu"><a class="menu-link" href="commands.html">Commands</a></div><div class="menu"><a class="menu-link" href="design.html">Design</a></div><div class="menu"><a class="menu-link" href="quickstarts.html">Quickstarts</a></div><div class="menu"><a class="menu-link" href="build.html">Build</a></div></div></div></div><div id="content-wrapper"><div id="sidebar-wrapper"><div id="sidebar"><div class="page-toc"><div class="page-toc-header"><div class="page-toc-title"></div></div><div class="page-toc-body"><div class="section1-toc"><div class="section1-toc-number">1</div><div class="section1-toc-title"><a href="#_overview">Overview</a></div></div><div class="section1-toc"><div class="section1-toc-number">2</div><div class="section1-toc-title"><a href="#_requirements">Requirements</a></div><div class="section2-toc"><div class="section2-toc-number">2.1</div><div class="section2-toc-title"><a href="#_requirements/_kubernetes_environment">Kubernetes Environment</a></div></div></div><div class="section1-toc"><div class="section1-toc-number">3</div><div class="section1-toc-title"><a href="#_build_from_source">Build from Source</a></div><div class="section2-toc"><div class="section2-toc-number">3.1</div><div class="section2-toc-title"><a href="#_build_from_source/_compiling_the_postgresql_operator">Compiling the PostgreSQL Operator</a></div></div><div class="section2-toc"><div class="section2-toc-number">3.2</div><div class="section2-toc-title"><a href="#_build_from_source/_create_namespace">Create Namespace</a></div></div><div class="section2-toc"><div class="section2-toc-number">3.3</div><div class="section2-toc-title"><a href="#_build_from_source/_deploy_the_postgresql_operator">Deploy the PostgreSQL Operator</a></div></div><div class="section2-toc"><div class="section2-toc-number">3.4</div><div class="section2-toc-title"><a href="#_build_from_source/_verify_installation">Verify Installation</a></div></div></div><div class="section1-toc"><div class="section1-toc-number">4</div><div class="section1-toc-title"><a href="#_makefile_targets">Makefile Targets</a></div></div></div></div></div></div><div id="page-wrapper"><div id="page-body"><div class="section1"><a id="_overview"></a><div class="section1-header"><div class="section1-number">1</div><div class="section1-title">Overview</div></div><div class="section-body"><div class="section-body-text">This document describes how to build from source code the Postgres Operator, mostly this is for developers or people wanting to hack on the operator.</div><div class="section-body-text">This document assumes you have already followed the Install instructions and have a working Kube environment.</div></div></div><div class="section1"><a id="_requirements"></a><div class="section1-header"><div class="section1-number">2</div><div class="section1-title">Requirements</div></div><div class="section-body"><div class="section-body-text">The operator is developed with the Golang versions great than or equal to version 1.8 See <a href="https://golang.org/dl/">Golang website</a> for details on installing golang.</div><div class="section-body-text">The Operator project builds and operates with the following containers:</div><ul class="list-unordered"><li class="list-unordered"><a href="https://hub.docker.com/r/crunchydata/pgo-lspvc/">PVC Listing Container</a></li><li class="list-unordered"><a href="https://hub.docker.com/r/crunchydata/pgo-rmdata/">Remove Data Container</a></li><li class="list-unordered"><a href="https://hub.docker.com/r/crunchydata/postgres-operator/">postgres-operator Container</a></li><li class="list-unordered"><a href="https://hub.docker.com/r/crunchydata/pgo-apiserver/">apiserver Container</a></li><li class="list-unordered"><a href="https://hub.docker.com/r/crunchydata/pgo-load/">file load Container</a></li></ul><div class="section-body-text">This Operator is developed and tested on the following operating systems but is known to run on other operating systems:</div><ul class="list-unordered"><li class="list-unordered"><b>CentOS 7</b></li><li class="list-unordered"><b>RHEL 7</b></li></ul><div class="section2"><a id="_requirements/_kubernetes_environment"></a><div class="section2-header"><div class="section2-number">2.1</div><div class="section2-title">Kubernetes Environment</div></div><div class="section-body"><div class="section-body-text">To test the <b>postgres-operator</b>, it is required to have a Kubernetes cluster environment. The Operator is tested on Kubeadm Kubernetes installed clusters. Other Kubernetes installation methods have been known to work as well.</div><div class="section-body-text"><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">Installing kubeadm - Official Kubernetes Documentation</a></div></div></div></div></div><div class="section1"><a id="_build_from_source"></a><div class="section1-header"><div class="section1-number">3</div><div class="section1-title">Build from Source</div></div><div class="section-body"><div class="section-body-text">Install a golang compiler, this can be done with either your package manager or by following directions from <a href="https://golang.org/dl/">https://golang.org/dl/</a>. The operator is currently built using golang version 1.8.X but also runs using golang version 1.9.X</div><div class="section-body-text">Then install the project library dependencies, the godep dependency manager is used as follows:</div><pre class="code-block">cd $COROOT
make setup</pre><div class="section2"><a id="_build_from_source/_compiling_the_postgresql_operator"></a><div class="section2-header"><div class="section2-number">3.1</div><div class="section2-title">Compiling the PostgreSQL Operator</div></div><div class="section-body"><pre class="code-block">cd $COROOT
make all
which pgo</pre></div></div><div class="section2"><a id="_build_from_source/_create_namespace"></a><div class="section2-header"><div class="section2-number">3.2</div><div class="section2-title">Create Namespace</div></div><div class="section-body"><div class="section-body-text">This example is based on a kubeadm installation with the admin user being already created. The example below assumes the cluster name is <b>kubernetes</b> and the cluster default user is <b>kubernetes-admin</b>.</div><pre class="code-block">kubectl create -f $COROOT/examples/demo-namespace.json
kubectl get namespaces</pre><div class="section-body-text">then set your context to the new demo namespace</div><pre class="code-block">sudo chmod o+w /etc/kubernetes
sudo chmod o+w /etc/kubernetes/admin.conf
kubectl config set-context demo --namespace=demo --cluster=kubernetes --user=kubernetes-admin
kubectl config use-context demo
kubectl config current-context</pre><div class="section-body-text">Permissions are granted to the Operator by means of a Service Account called <b>postgres-operator</b>. That service account is added to the Operator deployment.</div><div class="section-body-text">The postgres-operator service account is granted cluster-admin priviledges using a cluster role binding <b>postgres-operator-cluster-role-binding</b>.</div><div class="section-body-text">See <a href="https://kubernetes.io/docs/admin/authorization/rbac/">here</a> for more details on how to enable RBAC roles and modify the scope of the permissions to suit your needs.</div><div class="section-body-text">The sample service account and cluster role bindings specify the <b>demo</b> namespace. Edit the yaml definitions of these to match the namespace you are deploying the operator into.</div><div class="section-body-text">If you are not using the <b>demo</b> namespace, you will edit the following:</div><ul class="list-unordered"><li class="list-unordered">$COROOT/deploy/service-account.yaml</li><li class="list-unordered">$COROOT/deploy/cluster-role-binding.yaml</li></ul></div></div><div class="section2"><a id="_build_from_source/_deploy_the_postgresql_operator"></a><div class="section2-header"><div class="section2-number">3.3</div><div class="section2-title">Deploy the PostgreSQL Operator</div></div><div class="section-body"><div class="section-body-text"><b>NOTE</b>: This will create and use <b>/data</b> on your local system as the persistent store for the operator to use for its persistent volume.</div><pre class="code-block">cd $COROOT
make deployoperator
kubectl get pod -l 'name=postgres-operator'</pre><div class="section-body-text">You should see output similar to:</div><pre class="code-block">NAME                                 READY     STATUS    RESTARTS   AGE
postgres-operator-7f8db87c7b-4tk52   2/2       Running   0          8s</pre><div class="section-body-text">This output shows that both the <b>apiserver</b> and <b>postgres-operator</b> containers are in ready state and the pod is running.</div><div class="section-body-text">You can find the operator service IP address as follows:</div><pre class="code-block">kubectl get service postgres-operator
NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
postgres-operator   ClusterIP   10.105.56.167   <none>        8080/TCP,8443/TCP   1m</pre><div class="section-body-text">In this example, the <b>apiserver</b> is reachable at <b>https://10.105.56.167:8443</b>.</div><div class="section-body-text">When you first run the operator, it will create the required CustomResourceDefinitions. You can view these as follows:</div><pre class="code-block">kubectl get crd</pre><div class="section-body-text">Instead of using the bash script you can also deploy the operator using the provided Helm chart:</div><pre class="code-block">cd $COROOT/chart
helm install ./postgres-operator
helm ls</pre></div></div><div class="section2"><a id="_build_from_source/_verify_installation"></a><div class="section2-header"><div class="section2-number">3.4</div><div class="section2-title">Verify Installation</div></div><div class="section-body"><div class="section-body-text">When you first run the operator, it will look for the presence of the predefined custom resource definitions, and create them if not found. The best way to verify a successful deployment of the Operator is by viewing these custom resource definitions:</div><pre class="code-block">kubectl get crd
kubectl get pgclusters
kubectl get pgreplicas
kubectl get pgbackups
kubectl get pgupgrades
kubectl get pgpolicies
kubectl get pgingests
kubectl get pgtasks</pre><div class="section-body-text">At this point, you should be ready to start using the <b>pgo</b> client! Be sure to set the environment variable <b>CO_APISERVER_URL</b> to the DNS name of the <b>postgres-operator</b> service or to the IP address of the <b>postgres-operator</b> service IP address. For example:</div><pre class="code-block">export CO_APISERVER_URL=https://10.105.56.167:8443</pre><div class="section-body-text">Or if you have DNS configured on your client host:</div><pre class="code-block">export CO_APISERVER_URL=https://postgres-operator.demo.svc.cluster.local:8443</pre></div></div></div></div><div class="section1"><a id="_makefile_targets"></a><div class="section1-header"><div class="section1-number">4</div><div class="section1-title">Makefile Targets</div></div><div class="section-body"><div class="section-body-text">The following table describes the Makefile targets: .Makefile Targets</div><table class="table"><tr class="table-header-row"><th class="table-header-left">Target</th><th class="table-header-left">Description</th></tr><tr class="table-row"><td class="table-data-left">all</td><td class="table-data-left">compile all binaries and build all images</td></tr><tr class="table-row"><td class="table-data-left">setup</td><td class="table-data-left">fetch the dependent packages required to build with</td></tr><tr class="table-row"><td class="table-data-left">deployoperator</td><td class="table-data-left">deploy the Operator (apiserver and postgers-operator) to Kubernetes</td></tr><tr class="table-row"><td class="table-data-left">main</td><td class="table-data-left">compile the postgres-operator</td></tr><tr class="table-row"><td class="table-data-left">runmain</td><td class="table-data-left">locally execute the postgres-operator</td></tr><tr class="table-row"><td class="table-data-left">pgo</td><td class="table-data-left">build the pgo binary</td></tr><tr class="table-row"><td class="table-data-left">runpgo</td><td class="table-data-left">run the pgo binary</td></tr><tr class="table-row"><td class="table-data-left">runapiserver</td><td class="table-data-left">run the apiserver binary outside of Kube</td></tr><tr class="table-row"><td class="table-data-left">clean</td><td class="table-data-left">remove binaries and compiled packages, restore dependencies</td></tr><tr class="table-row"><td class="table-data-left">operatorimage</td><td class="table-data-left">compile and build the postgres-operator Docker image</td></tr><tr class="table-row"><td class="table-data-left">apiserverimage</td><td class="table-data-left">compile and build the apiserver Docker image</td></tr><tr class="table-row"><td class="table-data-left">lsimage</td><td class="table-data-left">build the lspvc Docker image</td></tr><tr class="table-row"><td class="table-data-left">loadimage</td><td class="table-data-left">build the file load Docker image</td></tr><tr class="table-row"><td class="table-data-left">rmdataimage</td><td class="table-data-left">build the data deletion Docker image</td></tr><tr class="table-row"><td class="table-data-left">release</td><td class="table-data-left">build the postgres-operator release</td></tr></table></div></div><div class="page-footer text-center">Prepared by Crunchy Data Solutions, Inc. &mdash; April 6, 2018</div></div></div></div></body></html>