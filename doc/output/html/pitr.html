<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>PITR (Point in Time Recovery) Support in Crunchy Container Suite</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8"></meta><meta property="og:site_name" content="Crunchy Containers"></meta><meta property="og:title" content="PITR (Point in Time Recovery) Support in Crunchy Container Suite"></meta><meta property="og:type" content="website"></meta><meta property="og:image:type" content="image/png"></meta><meta property="og:image" content="{[backrest-url-base]}/logo.svg"></meta><meta name="description" content="PITR (Point in Time Recovery) Support in Crunchy Container Suite"></meta><meta property="og:description" content="PITR (Point in Time Recovery) Support in Crunchy Container Suite"></meta><link rel="stylesheet" href="default.css" type="text/css"></link></head><body><div id="header-wrapper"><div class="page-header" id="page-header"><div class="page-header-logo"><img src="logo.svg"></div><div class="page-header-title">PITR (Point in Time Recovery) Support in Crunchy Container Suite</div></div><div class="page-menu"><div class="menu-body"><div class="menu"><a class="menu-link" href="install.html">Home</a></div><div class="menu"><a class="menu-link" href="containers.html">Containers</a></div><div class="menu"><a class="menu-link" href="examples.html">Examples</a></div><div class="menu"><a class="menu-link" href="pitr.html">PITR</a></div><div class="menu"><a class="menu-link" href="dedicated.html">Dedicated</a></div><div class="menu"><a class="menu-link" href="backrest.html">Backup</a></div></div></div></div><div id="content-wrapper"><div id="sidebar-wrapper"><div id="sidebar"><div class="page-toc"><div class="page-toc-header"><div class="page-toc-title"></div></div><div class="page-toc-body"><div class="section1-toc"><div class="section1-toc-number">1</div><div class="section1-toc-title"><a href="#_description">Description</a></div><div class="section2-toc"><div class="section2-toc-number">1.1</div><div class="section2-toc-title"><a href="#_description/_wal">WAL</a></div></div><div class="section2-toc"><div class="section2-toc-number">1.2</div><div class="section2-toc-title"><a href="#_description/_restoring_from_wal">Restoring from WAL</a></div></div><div class="section2-toc"><div class="section2-toc-number">1.3</div><div class="section2-toc-title"><a href="#_description/_hint">Hint</a></div></div><div class="section2-toc"><div class="section2-toc-number">1.4</div><div class="section2-toc-title"><a href="#_description/_examples">Examples</a></div></div></div><div class="section1-toc"><div class="section1-toc-number">2</div><div class="section1-toc-title"><a href="#_legal_notices">Legal Notices</a></div></div></div></div></div></div><div id="page-wrapper"><div id="page-body"><div class="section1"><a id="_description"></a><div class="section1-header"><div class="section1-number">1</div><div class="section1-title">Description</div></div><div class="section-body"><div class="section-body-text">PITR (point-in-time-recovery) is a feature that lets a DBA recreate a database from backup and log files at a certain point in time. This is useful in that the log files record only the small changes made to a database over time. For large databases, doing a full database backup is not workable given the time and space it requires. Therefore, with PITR, you only need to save the log files plus a known full backup to recreate your database in the event of a database or system failure.</div><div class="section-body-text">Support was added into the Crunchy Container Suite as of version 1.2.3.</div><div class="section-body-text">This document will discuss the design and usage of the PITR features as implemented so far.</div><div class="section2"><a id="_description/_wal"></a><div class="section2-header"><div class="section2-number">1.1</div><div class="section2-title">WAL</div></div><div class="section-body"><div class="section-body-text">Write Ahead Logs (WAL) is created when you enable continuous archiving as described <a href="https://www.postgresql.org/docs/9.5/static/continuous-archiving.html">here.</a></div><div class="section-body-text">By default in the crunchy-postgres container, WAL logging is <b>not</b> enabled. To enable WAL logging, you set the following environment variables when starting the crunchy-postgres container:</div><pre class="code-block">ARCHIVE_MODE=on
ARCHIVE_TIMEOUT=60</pre><div class="section-body-text">These variables set the same name settings within the postgresql.conf file that is used by the database.</div><div class="section-body-text">When set, WAL files generated by the database will be written out to the /pgwal mount point.</div></div></div><div class="section2"><a id="_description/_restoring_from_wal"></a><div class="section2-header"><div class="section2-number">1.2</div><div class="section2-title">Restoring from WAL</div></div><div class="section-body"><div class="section-body-text">A full backup is required to do a PITR. crunchy-backup currently performs this role, running a pg_basebackup for you. This is required for PITR.</div><div class="section-body-text">After a backup has been performed, code was added into crunchy-postgres which during a backup restore, will also check to see if you want to do a PITR.</div><div class="section-body-text">When you run a crunchy-postgres container and specify a /recover volume mount, this will trigger logic for PITR during container startup.</div><div class="section-body-text">/backup will still be used to find the base backup you want to use, just like a normal database backup restore.</div><div class="section-body-text">/pgwal can still be used to write out new WAL files from the restored database container.</div><div class="section-body-text">The RECOVERY_TARGET_NAME environment variable is used to tell the PITR logic what target name you want to use for the PITR. RECOVERY_TARGET_TIME is also an optional environment variable that lets you restore using a known time stamp. If you don't specify either of these environment variables, then the PITR logic will assume you want to restore using all the WAL files or essentially the last known recovery point.</div><div class="section-body-text">The RECOVERY_TARGET_INCLUSIVE environment variable is also available to let you control the setting of the recovery.conf setting <b>recovery_target_inclusive</b>. If you do not set this environment variable the default is <b>true</b>.</div></div></div><div class="section2"><a id="_description/_hint"></a><div class="section2-header"><div class="section2-number">1.3</div><div class="section2-title">Hint</div></div><div class="section-body"><div class="section-body-text">Once you recover a database using PITR, it will be in read-only mode. To make the database resume as a writable database, run the following sql command:</div><pre class="code-block">select pg_xlog_replay_resume();</pre><div class="section-body-text">This command changed for PG10 to:</div><pre class="code-block">postgres=# select pg_wal_replay_resume();</pre></div></div><div class="section2"><a id="_description/_examples"></a><div class="section2-header"><div class="section2-number">1.4</div><div class="section2-title">Examples</div></div><div class="section-body"><div class="section-body-text">Examples for PITR have been created within the standalone, openshift, and kubernetes examples directories.</div><div class="section-body-text">There is a blog on how the example works documented here: <a href="https://blog.openshift.com/crunchy-postgresql-containers-on-openshift-performing-point-in-time-recovery/">https://blog.openshift.com/crunchy-postgresql-containers-on-openshift-performing-point-in-time-recovery/</a></div></div></div></div></div><div class="section1"><a id="_legal_notices"></a><div class="section1-header"><div class="section1-number">2</div><div class="section1-title">Legal Notices</div></div><div class="section-body"><div class="section-body-text">Copyright &copy; 2018 Crunchy Data Solutions, Inc.</div><div class="section-body-text">CRUNCHY DATA SOLUTIONS, INC. PROVIDES THIS GUIDE <q>AS IS</q> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</div><div class="section-body-text">Crunchy, Crunchy Data Solutions, Inc. and the Crunchy Hippo Logo are trademarks of Crunchy Data Solutions, Inc.</div></div></div><div class="page-footer text-center">Prepared by Crunchy Data Solutions, Inc. &mdash; March 22, 2018</div></div></div></div></body></html>