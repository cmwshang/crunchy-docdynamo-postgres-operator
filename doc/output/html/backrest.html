<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>pgbackrest Support in Crunchy Container Suite</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8"></meta><meta property="og:site_name" content="Crunchy Containers"></meta><meta property="og:title" content="pgbackrest Support in Crunchy Container Suite"></meta><meta property="og:type" content="website"></meta><meta property="og:image:type" content="image/png"></meta><meta property="og:image" content="{[backrest-url-base]}/logo.svg"></meta><meta name="description" content="pgbackrest Support in Crunchy Container Suite"></meta><meta property="og:description" content="pgbackrest Support in Crunchy Container Suite"></meta><link rel="stylesheet" href="default.css" type="text/css"></link></head><body><div id="header-wrapper"><div class="page-header" id="page-header"><div class="page-header-logo"><img src="logo.svg"></div><div class="page-header-title">pgbackrest Support in Crunchy Container Suite</div></div><div class="page-menu"><div class="menu-body"><div class="menu"><a class="menu-link" href="install.html">Home</a></div><div class="menu"><a class="menu-link" href="containers.html">Containers</a></div><div class="menu"><a class="menu-link" href="examples.html">Examples</a></div><div class="menu"><a class="menu-link" href="pitr.html">PITR</a></div><div class="menu"><a class="menu-link" href="dedicated.html">Dedicated</a></div><div class="menu"><a class="menu-link" href="backrest.html">Backup</a></div></div></div></div><div id="content-wrapper"><div id="sidebar-wrapper"><div id="sidebar"><div class="page-toc"><div class="page-toc-header"><div class="page-toc-title"></div></div><div class="page-toc-body"><div class="section1-toc"><div class="section1-toc-number">1</div><div class="section1-toc-title"><a href="#_description">Description</a></div><div class="section2-toc"><div class="section2-toc-number">1.1</div><div class="section2-toc-title"><a href="#_description/_pgbackrest_configuration">pgbackrest Configuration</a></div></div><div class="section2-toc"><div class="section2-toc-number">1.2</div><div class="section2-toc-title"><a href="#_description/_performing_a_backup">Performing a Backup</a></div></div><div class="section2-toc"><div class="section2-toc-number">1.3</div><div class="section2-toc-title"><a href="#_description/_running_the_examples">Running the Examples</a></div></div><div class="section2-toc"><div class="section2-toc-number">1.4</div><div class="section2-toc-title"><a href="#_description/_performing_a_restore">Performing a Restore</a></div></div></div><div class="section1-toc"><div class="section1-toc-number">2</div><div class="section1-toc-title"><a href="#_legal_notices">Legal Notices</a></div></div></div></div></div></div><div id="page-wrapper"><div id="page-body"><div class="section1"><a id="_description"></a><div class="section1-header"><div class="section1-number">1</div><div class="section1-title">Description</div></div><div class="section-body"><div class="section-body-text">pgbackrest is a utility that performs a backup, restore, archive function for a PostgreSQL database. pgbackrest is written and maintained by David Steele, a fellow Crunchy Data colleague!</div><div class="section-body-text">pgbackrest is described here:</div><div class="section-body-text"><a href="http://www.pgbackrest.org/">http://www.pgbackrest.org/</a></div><div class="section-body-text">New functionality for pgbackrest was added into the Crunchy Container Suite as of version 1.3.1. Backups are currently performed by manually executing pgbackrest commands against the desired pod. Restores can now be performed via a new crunchy-backrest-restore container, which offers FULL or DELTA restore capability.</div><div class="section-body-text">This document will discuss the design and usage of the pgbackrest features as implemented so far.</div><div class="section2"><a id="_description/_pgbackrest_configuration"></a><div class="section2-header"><div class="section2-number">1.1</div><div class="section2-title">pgbackrest Configuration</div></div><div class="section-body"><div class="section-body-text">pgbackrest is configured using a pgbackrest.conf file that is mounted into the crunchy-postgres container at /pgconf.</div><div class="section-body-text">If you place a pgbackrest.conf file within this mounted directory, it will trigger the use of pgbackrest within the PostgreSQL container as the archive_command and will turn on the archive_mode to begin archival. You still need to define the ARCHIVE_TIMEOUT environment variable within your container configuration because it is set to a disable value of 0 by default!</div><div class="section-body-text">The following changes will be made to the container's postgresql.conf file:</div><pre class="code-block">ARCHIVE_MODE=on
ARCHIVE_TIMEOUT=60
ARCHIVE_COMMAND='pgbackrest --stanza=db archive-push %p'</pre><div class="section-body-text">If you are using a postgres image older than <b>1.7.1</b>, <b>archive_command</b> must specify where the <b>pgbackrest.conf</b> file is located:</div><pre class="code-block">ARCHIVE_COMMAND='pgbackrest --config=/pgconf/pgbackrest.conf --stanza=db archive-push %p'</pre><div class="section-body-text">This requires you use a pgbackrest stanza name of <b>db</b> within the pgbackrest.conf file you mount.</div><div class="section-body-text">When set, WAL files generated by the database will be written out to the /backrestrepo mount point.</div></div></div><div class="section2"><a id="_description/_performing_a_backup"></a><div class="section2-header"><div class="section2-number">1.2</div><div class="section2-title">Performing a Backup</div></div><div class="section-body"><div class="section-body-text">Examples for backrest have been created within the standalone, openshift, and kubernetes examples directories.</div><div class="section-body-text">Once you configure the crunchy-postgres container to use pgbackrest, you will perform a backup using the following commands:</div><pre class="code-block">docker exec -it primary-backrest bash
/usr/bin/pgbackrest --stanza=db backup</pre><div class="section-body-text">Examine the contents of the mounted /backrestrepo directory to see the archive files and also the backup files.</div></div></div><div class="section2"><a id="_description/_running_the_examples"></a><div class="section2-header"><div class="section2-number">1.3</div><div class="section2-title">Running the Examples</div></div><div class="section-body"><div class="section3"><a id="_description/_running_the_examples/_kubernetes"></a><div class="section3-header"><div class="section3-number">1.3.1</div><div class="section3-title">Kubernetes</div></div><div class="section-body"><div class="section-body-text">Start the example as follows:</div><pre class="code-block">cd $CCPROOT/examples/kube/backrest
./run.sh</pre><div class="section-body-text">This will create the following in your Kubernetes environment:</div><ul class="list-unordered"><li class="list-unordered">A configMap named backrestconf which contains the pgbackrest.conf file</li><li class="list-unordered">primary-backrest pod with pgbackrest archive enabled. An initial stanza db will be created on initialization</li><li class="list-unordered">primary-backrest service</li></ul><div class="section-body-text">The crunchy-pvc will be used for /pgdata, and crunchy-pvc2 for the /backrestrepo. Examine the /backrestrepo location to view the archive directory and ensure WAL archiving is working.</div></div></div><div class="section3"><a id="_description/_running_the_examples/_openshift"></a><div class="section3-header"><div class="section3-number">1.3.2</div><div class="section3-title">OpenShift</div></div><div class="section-body"><div class="section-body-text">Start by running the example database container:</div><pre class="code-block">cd $CCPROOT/examples/openshift/backrest
./run.sh</pre><div class="section-body-text">This will create the following:</div><ul class="list-unordered"><li class="list-unordered">PV/PVC for /pgconf and /backrestrepo volumes</li><li class="list-unordered">primary database pod</li><li class="list-unordered">primary service</li><li class="list-unordered">configmap holding the pgbackrest.conf config file</li></ul><div class="section-body-text">The archive files are written to the NFS path of /mnt/nfsfileshare/backrestrepo.</div><div class="section-body-text">The presence of /pgconf/pgbackrest.conf is what is used to determine whether pgbackrest will be used as the archive command or not. You will need to specify the ARCHIVE_TIMEOUT environment variable as well to use this.</div><div class="section-body-text">After you run the example, you should see archive files being written to the /backrestrepo volume (/mnt/nfsfileshare/backrestrepo).</div></div></div><div class="section3"><a id="_description/_running_the_examples/_manual_backup"></a><div class="section3-header"><div class="section3-number">1.3.3</div><div class="section3-title">Manual Backup</div></div><div class="section-body"><div class="section-body-text">You can create a backup using backrest using this command within the container:</div><pre class="code-block">pgbackrest --stanza=db backup</pre></div></div></div></div><div class="section2"><a id="_description/_performing_a_restore"></a><div class="section2-header"><div class="section2-number">1.4</div><div class="section2-title">Performing a Restore</div></div><div class="section-body"><div class="section-body-text">There are two options to choose from when performing a restore, DELTA and FULL. A FULL is the default; a DELTA will only occur if the environment variable DELTA is specified in the restore-job spec. Consult the pgbackrest user guide to determine which is best suited to run.</div><div class="section-body-text">Steps for FULL restore</div><ul class="list-unordered"><li class="list-unordered">Delete the primary-backrest pod, if still running using</li><li class="list-unordered">Empty the PGDATA directory (remove all files)</li><li class="list-unordered">Navigate to the backrest-restore examples directory. Execute the full-restore.sh script.</li><li class="list-unordered">Check the restore logs (db-restore.log) in the /backrestrepo mountpointfor success. You can also view the logs of the completed job pod with kubectl get pod -a</li><li class="list-unordered">Re-create the primary-backrest pod in the backrest examples directory. The database will recover.</li></ul><div class="section-body-text">Steps for DELTA restore</div><ul class="list-unordered"><li class="list-unordered">Delete the primary-backrest pod, if still running</li><li class="list-unordered">rm postmaster.pid from PGDATA.</li><li class="list-unordered">Navigate to the backrest-restore examples directory. Execute the delta-restore.sh script.</li><li class="list-unordered">Check the restore logs (db-restore.log) in the /backrestrepo mountpointfor success. You can also view the logs of the completed job pod with kubectl get pod -a</li><li class="list-unordered">Re-create the primary-backrest pod in the backrest examples directory. The database will recover only files that have changed from the last backup.</li></ul></div></div></div></div><div class="section1"><a id="_legal_notices"></a><div class="section1-header"><div class="section1-number">2</div><div class="section1-title">Legal Notices</div></div><div class="section-body"><div class="section-body-text">Copyright &copy; 2018 Crunchy Data Solutions, Inc.</div><div class="section-body-text">CRUNCHY DATA SOLUTIONS, INC. PROVIDES THIS GUIDE <q>AS IS</q> WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF NON INFRINGEMENT, MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.</div><div class="section-body-text">Crunchy, Crunchy Data Solutions, Inc. and the Crunchy Hippo Logo are trademarks of Crunchy Data Solutions, Inc.</div></div></div><div class="page-footer text-center">Prepared by Crunchy Data Solutions, Inc. &mdash; March 22, 2018</div></div></div></div></body></html>